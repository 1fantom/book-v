<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Silvia üíú –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
  --clr-bg: #f8f9fa;           /* –æ—á–µ–Ω—å —Å–≤–µ—Ç–ª—ã–π —Ñ–æ–Ω */
  --clr-fg: #343a40;           /* —Ç–µ–º–Ω—ã–π –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç */
  --clr-panel: #e9ecef;        /* —Å–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π –¥–ª—è –ø–∞–Ω–µ–ª–µ–π */
  --clr-card: #dee2e6;         /* —á—É—Ç—å —Ç–µ–º–Ω–µ–µ –ø–∞–Ω–µ–ª—å, –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ */
  --clr-header: #ced4da;       /* —Ñ–æ–Ω –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ */
  --clr-accent: #adb5bd;       /* –∞–∫—Ü–µ–Ω—Ç–Ω—ã–π —Å–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π */
  --clr-accent-hover: #6c757d; /* –±–æ–ª–µ–µ –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–π –∞–∫—Ü–µ–Ω—Ç –¥–ª—è –Ω–∞–≤–µ–¥–µ–Ω–∏—è */
  --clr-border: #495057;       /* —Ü–≤–µ—Ç –≥—Ä–∞–Ω–∏—Ü */
}

    [data-theme="dark"] {
      /* –¥–ª—è —Ç—ë–º–Ω–æ–π —Ç–µ–º—ã –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –∏–ª–∏ –ø–æ–¥–æ–±—Ä–∞—Ç—å —Ç—ë–º–Ω—ã–µ –∞–Ω–∞–ª–æ–≥–∏ */
    }
    * { box-sizing: border-box; margin:0; padding:0 }
    html,body{height:100%}
    body {
      display:flex; flex-direction:column;
      font-family:'Segoe UI',sans-serif;
      background:var(--clr-bg); color:var(--clr-fg);
    }
    header {
      display:flex; align-items:center;
      background:var(--clr-header); color:var(--clr-fg);
      padding:0 20px; height:60px; flex-shrink:0;
      box-shadow:0 2px 4px rgba(0,0,0,.1);
    }
    #toggleBtn {
      width:36px;height:36px;margin-right:12px;
      background:url('https://i.pinimg.com/736x/07/97/d6/0797d668e53439bb6b00c4a52ce547a0.jpg')
        no-repeat center/contain;
      border:none;cursor:pointer;
    }
    
    #title{font-size:1.3rem}

    .container{display:flex;flex:1;overflow:hidden}
    aside#sidebar {
      width:400px; background:var(--clr-panel);
      padding:20px; overflow-y:auto;
      transform:translateX(-100%); transition:.3s;
      flex-shrink:0;
    }
    aside#sidebar.open{transform:translateX(0)}
    aside#sidebar h2{margin-bottom:8px;color:var(--clr-fg)}

    #symbolButtons {
      display:grid;grid-template-columns:repeat(4,1fr);
      gap:8px;margin-bottom:16px;
    }
    #symbolButtons button {
      background:var(--clr-accent);color:var(--clr-fg);
      border:none;border-radius:4px;padding:8px;
      cursor:pointer;transition:.2s;
    }
    #symbolButtons button:hover {
      background:var(--clr-accent-hover);
    }

    #functions{display:flex;flex-direction:column;gap:12px;margin-bottom:16px}
    .fn-row {
      display:grid;
      grid-template-columns: 1fr 50px 50px 40px auto;
      gap:8px;align-items:center;
    }
    .fn-row input[type="text"] {
      padding:8px;border:1px solid var(--clr-border);
      border-radius:4px;background:var(--clr-card);
    }
    .fn-row select {
      padding:6px;border-radius:4px;border:1px solid var(--clr-border);
      background:var(--clr-card);
    }
    .fn-row input[type="color"] {
      width:36px;height:36px;border:none;border-radius:4px;
    }
    .fn-row label{font-size:.9rem}
    .fn-row button.del {
      background:#e63946;color:#fff;border:none;
      border-radius:4px;padding:8px;cursor:pointer;
    }

    #addFn,#plotBtn,#resetBtn,#exportBtn {
      width:100%;padding:10px;border:none;border-radius:4px;
      cursor:pointer;margin-bottom:8px;
    }
  
    #addFn { background:var(--clr-header);color:var(--clr-fg) }
    #addFn:hover { background:var(--clr-accent-hover) }
    #plotBtn { background:var(--clr-header);color:var(--clr-fg) }
    #plotBtn:hover { background:var(--clr-accent-hover) }
    #resetBtn { background:#f08a5d;color:#fff }
    #exportBtn { background:#50b2b6;color:#fff }

    #derivPanel,#legend,#calculationPanel {
      background:var(--clr-card);padding:12px;border-radius:4px;
      box-shadow:0 1px 3px rgba(0,0,0,.1);margin-bottom:16px;
    }
    #derivPanel h2,#legend h2,#calculationPanel h2 {
      margin-bottom:8px;color:var(--clr-fg);
    }
    #derivList .entry,#results p {
      margin-bottom:8px;font-size:.9rem;
    }
    #legend .item {
      display:flex;align-items:center;gap:8px;font-size:.9rem;
    }
    #legend .color-box {
      width:16px;height:16px;border:1px solid var(--clr-fg);
      border-radius:2px;
    }

    #main{flex:1;position:relative;display:flex;flex-direction:column}
    canvas {
      flex:1;background:var(--clr-card);cursor:grab;
      box-shadow:inset 0 0 5px rgba(0,0,0,.05);
    }
    #calculationPanel {
      position:absolute;top:20px;right:20px;
      width:300px;max-height:calc(100%-40px);
      overflow-y:auto;
    }
  </style>
</head>
<body data-theme="light">
  <header>
    <button id="toggleBtn" title="–û—Ç–∫—Ä—ã—Ç—å –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä"></button>
    <div id="title">–ì—Ä–∞—Ñ–∏–∫–∏ –∏ —Ñ—É–Ω–∫—Ü–∏–∏</div>
    <button id="themeBtn" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">üåì</button>
  </header>
  <div class="container">
    <aside id="sidebar">
      <h2>–°–∏–º–≤–æ–ª—ã</h2>
      <div id="symbolButtons">
        <button onclick="insert('sin(')">sin(</button>
        <button onclick="insert('cos(')">cos(</button>
        <button onclick="insert('tan(')">tan(</button>
        <button onclick="insert('^')">^</button>
        <button onclick="insert('sqrt(')">‚àö(</button>
        <button onclick="insert('log(')">log(</button>
        <button onclick="insert('ln(')">ln(</button>
        <button onclick="insert('*')">√ó</button>
        <button onclick="insert('/')">√∑</button>
        <button onclick="insert('pi')">œÄ</button>
        <button onclick="insert('abs(')">|x|</button>
        <button onclick="insert('sum(')">Œ£(</button>
        <button onclick="insert('integrate(')">‚à´(</button>
        <button onclick="insert('(')">(</button>
        <button onclick="insert(')')">)</button>
      </div>

      <h2>–§—É–Ω–∫—Ü–∏–∏</h2>
      <div id="functions"></div>
      <button id="addFn">+ –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é</button>

      <div id="derivPanel">
        <h2>–ü—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–µ</h2>
        <div id="derivList">
          <p>–ù–∞–∂–º–∏—Ç–µ ¬´–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –≤—Å—ë¬ª, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∑–¥–µ—Å—å.</p>
        </div>
      </div>

      <div id="legend">
        <h2>–õ–µ–≥–µ–Ω–¥–∞</h2>
        <div id="legendList"></div>
      </div>

      <button id="plotBtn">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –≤—Å—ë</button>
      <button id="resetBtn">–°–±—Ä–æ—Å–∏—Ç—å –º–∞—Å—à—Ç–∞–±</button>
      <button id="exportBtn">–°–∫–∞—á–∞—Ç—å PNG</button>
      <button id="myCustomBtn" style="width:100%; padding:10px; margin-bottom:8px; border:none; border-radius:4px; background:#4a474e; color:#fff; cursor:pointer;">
         –í –º–µ–Ω—é
      </button>

    </aside>

    <section id="main">
      <canvas id="graph"></canvas>
      <div id="calculationPanel">
        <h2>üìê –ü–æ–¥—Å—á—ë—Ç—ã</h2>
        <div id="results">
          <p>–î–æ–±–∞–≤—å—Ç–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –≤—Å—ë¬ª...</p>
        </div>
      </div>
    </section>
  </div>
 <script>fetch('header.html')
      .then(response => response.text())
      .then(html => {
        document.getElementById('header-placeholder').innerHTML = html;
      })
      .catch(() => {
        document.getElementById('header-placeholder').innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —à–∞–ø–∫–∏ –∏ –º–µ–Ω—é</p>';
      });
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.1/math.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script src="js/menuToggle.js" defer></script>
  <script>
    // Theme
    const themeBtn = document.getElementById('themeBtn');
    themeBtn.onclick = () => {
      const t = document.body.dataset.theme==='light'?'dark':'light';
      document.body.dataset.theme = t;
      localStorage.setItem('theme', t);
    };
    const saved = localStorage.getItem('theme');
    if(saved) document.body.dataset.theme = saved;

    // Sidebar
    document.getElementById('toggleBtn').onclick = () =>
      document.getElementById('sidebar').classList.toggle('open');

    // Canvas
    const canvas = document.getElementById('graph'),
          ctx    = canvas.getContext('2d'),
          sidebarW = 400 + 360;
    canvas.width  = window.innerWidth - sidebarW;
    canvas.height = window.innerHeight;
    let scale=40, offsetX=canvas.width/2, offsetY=canvas.height/2;
    let dragging=false, dragStart={};

    // Refs
    const funcsDiv   = document.getElementById('functions'),
          derivList  = document.getElementById('derivList'),
          legendList = document.getElementById('legendList'),
          resultsDiv = document.getElementById('results'),
          resetBtn   = document.getElementById('resetBtn'),
          exportBtn  = document.getElementById('exportBtn');

    let functionsList=[];

    // Symbol insert
    let lastInput=null;
    document.addEventListener('focusin',e=>{
      if(e.target.matches('.fn-input')) lastInput=e.target;
    });
    function insert(sym){
      if(!lastInput) return;
      const s=lastInput.selectionStart,e=lastInput.selectionEnd;
      lastInput.value = lastInput.value.slice(0,s)+sym+lastInput.value.slice(e);
      lastInput.focus();
      lastInput.setSelectionRange(s+sym.length,s+sym.length);
    }

    // Add function row
    function addFunction(expr='',color=getRandomColor(),plotDeriv=false,order=1){
      const row=document.createElement('div');
      row.className='fn-row';
      row.innerHTML=`
        <input type="text" class="fn-input" placeholder="y(x)=x^2" value="${expr}">
        <select class="fn-order">
          ${[...Array(5)].map((_,i)=>
            `<option ${order===i?'selected':''} value="${i}">${i}</option>`
          ).join('')}
        </select>
        <input type="color" class="fn-color" value="${color}">
        <label><input type="checkbox" class="fn-deriv"/> f'</label>
        <button class="del">‚úï</button>
      `;
      funcsDiv.appendChild(row);
      row.querySelector('.del').onclick=()=>{row.remove();updateLegend()};
      row.querySelectorAll('.fn-input,.fn-color,.fn-deriv,.fn-order')
         .forEach(el=>el.oninput=updateLegend);
      updateLegend();
    }
    document.getElementById('addFn').onclick=()=>addFunction();

    // Update legend & deriv list
    function updateLegend(){
      derivList.innerHTML=''; legendList.innerHTML=''; functionsList=[];
      document.querySelectorAll('.fn-row').forEach((row,i)=>{
        const raw=row.querySelector('.fn-input').value.trim();
        const expr=raw.replace(/^\s*y['‚Äô‚Äµ]*\s*\(x\)\s*=\s*/,'');
        if(!expr) return;
        const order=+row.querySelector('.fn-order').value;
        const deriv=row.querySelector('.fn-deriv').checked;
        const color=row.querySelector('.fn-color').value;
        functionsList.push({expr,order,deriv,color});
        // legend
        const li=document.createElement('div');li.className='item';
        li.innerHTML=`<div class="color-box" style="background:${color}"></div>
                      <span>f${i+1}(x)${deriv?` & f${i+1}^(${order})(x)`:''}</span>`;
        legendList.appendChild(li);
      });
    }

    // Draw axes
    function drawAxes(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.strokeStyle='#aaa';ctx.lineWidth=1;
      for(let x=-offsetX;x<canvas.width-offsetX;x+=scale){
        ctx.beginPath();ctx.moveTo(x+offsetX,0);
        ctx.lineTo(x+offsetX,canvas.height);ctx.stroke();
      }
      for(let y=-offsetY;y<canvas.height-offsetY;y+=scale){
        ctx.beginPath();ctx.moveTo(0,y+offsetY);
        ctx.lineTo(canvas.width,y+offsetY);ctx.stroke();
      }
      ctx.strokeStyle='#333';ctx.lineWidth=2;
      ctx.beginPath();ctx.moveTo(0,offsetY);
      ctx.lineTo(canvas.width,offsetY);ctx.stroke();
      ctx.beginPath();ctx.moveTo(offsetX,0);
      ctx.lineTo(offsetX,canvas.height);ctx.stroke();
    }

    // Draw all
    function drawAll(){
      drawAxes();
      let calcHTML='', dHTML='';
      functionsList.forEach(({expr,order,deriv,color},i)=>{
        let node; try{node=math.parse(expr)}catch(err){
          calcHTML+=`<p style="color:red;">–û—à–∏–±–∫–∞ f${i+1}: ${err.message}</p>`;return;}
        // nth derivative
        let nnode=node;
        for(let k=0;k<order;k++){
          try{nnode=math.derivative(nnode,'x')}catch(err){
            calcHTML+=`<p style="color:red;">–û—à–∏–±–∫–∞ f${i+1}^(${order}): ${err.message}</p>`;return;}
        }
        // draw derivative only
        if(deriv){
          ctx.beginPath();ctx.strokeStyle=color;ctx.lineWidth=2;ctx.setLineDash([5,5]);
          let first=true;
          for(let px=0;px<canvas.width;px++){
            const x=(px-offsetX)/scale;
            let y;try{y=nnode.evaluate({x})}catch{continue}
            if(typeof y!=='number'||!isFinite(y))continue;
            const py=offsetY-y*scale;
            first?ctx.moveTo(px,py):ctx.lineTo(px,py);
            first=false;
          }
          ctx.stroke();ctx.setLineDash([]);
        } else {
          // draw function
          ctx.beginPath();ctx.strokeStyle=color;ctx.lineWidth=2;ctx.setLineDash([]);
          let first=true;
          for(let px=0;px<canvas.width;px++){
            const x=(px-offsetX)/scale;
            let y;try{y=node.evaluate({x})}catch{continue}
            if(typeof y!=='number'||!isFinite(y))continue;
            const py=offsetY-y*scale;
            first?ctx.moveTo(px,py):ctx.lineTo(px,py);
            first=false;
          }
          ctx.stroke();
        }
        // panels
        if(deriv){
          dHTML+=`<div class="entry">f<sup>(${order})</sup><sub>${i+1}</sub>(x)=\\(${nnode.toTex()}\\)</div>`;
        }
        calcHTML+=`<p>\\(f_${i+1}^(${order})(1)=${math.format(nnode.evaluate({x:1}),6)}\\)</p><hr>`;
      });
      derivList.innerHTML = dHTML||'<p>–û—Ç–º–µ—Ç—å—Ç–µ —á–µ–∫–±–æ–∫—Å –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –≤—Å—ë¬ª.</p>';
      resultsDiv.innerHTML = calcHTML;
      MathJax.typeset();
    }

    // Buttons
    document.getElementById('plotBtn').onclick=()=>{
      updateLegend();drawAll();
    };
    resetBtn.onclick=()=>{scale=40;offsetX=canvas.width/2;offsetY=canvas.height/2;drawAll()};
    exportBtn.onclick=()=>{
      const a=document.createElement('a');
      a.download='graph.png';a.href=canvas.toDataURL();a.click();
    };

    // Zoom & pan
    canvas.onwheel=e=>{e.preventDefault();
      const z=e.deltaY<0?1.1:0.9;scale*=z;
      const mx=e.offsetX,my=e.offsetY;
      offsetX=mx-(mx-offsetX)*z;offsetY=my-(my-offsetY)*z;
      drawAll();
    };
    canvas.onmousedown=e=>{dragging=true;dragStart={x:e.clientX,y:e.clientY};canvas.style.cursor='grabbing'};
    window.onmouseup=()=>{dragging=false;canvas.style.cursor='grab'};
    window.onmousemove=e=>{if(!dragging)return;
      offsetX+=e.clientX-dragStart.x;offsetY+=e.clientY-dragStart.y;
      dragStart={x:e.clientX,y:e.clientY};drawAll();
    };

    function getRandomColor(){
      return '#'+Math.floor(Math.random()*0xFFFFFF).toString(16).padStart(6,'0');
    }

    // Init
    addFunction('sin(x)','#abc4ff',true,1);
    addFunction('x^2','#b6ccfe',false,2);
    updateLegend();drawAxes();
  </script>
</body>
</html>
